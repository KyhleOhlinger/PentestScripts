#!/bin/bash
#Simple LDAP Query Bash Script
#Check if argument was provided
if [[ $# -eq 0 ]]; then
	echo "[*] LDAP Search Script"
	echo "[*] Usage : $0 <domain name> $1 <username> $2 <password>"
	printf "[*] Untested Commands:\n\tldapsearch -x -h IP -s base namingcontexts \n\tldapsearch -x -h IP -b 'dc=X,dc=Y'\n\n"
	exit 0
fi

# If argument was given, run LDAP query against the domain
echo "Domain Name: $1"
echo "Username: $2"
echo "Password: $3"
DC=",DC="
domain="DC=${1//./$DC}"

echo $domain

printf "\n"
echo "[0] DHCP Discovery"
echo "[1] DNS Server Enumeration"
echo "[2] Domain Users"
echo "[3] Domain Groups"
echo "[4] Domain Admins"
echo "[5] Domain Computers"
echo "[6] Kerberoastable SPNs"
echo "[7] Service Principal Names"
echo "[8] GPO Names"
echo "[9] Users with Unconstrained Delegation"
echo "[10] Computers with Unconstrained Delegation"
echo "[11] Admin Objects"
echo "[12] Potential Passwords"
printf "\n"

echo -n "Please Choose the Query you want to run and the press [ENTER]: "
read Query

#LDAP Queries
case $Query in
    0 )
	nmap --script broadcast-dhcp-discover ;; 
    1 )
        ldapsearch -LLL -x -H ldap://$1 -b '' -s base '(objectclass=*)' ;;
    2 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "(objectClass=user)" sAMAccountName userPrincipalName memberOf | tee domain_users.lst ;;
    3 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "(objectClass=group)" sAMAccountName member memberOf | tee domain_groups.lst ;; 
    4 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "(&(objectClass=user)(memberof:1.2.840.113556.1.4.1941:=CN=Domain Admins,CN=Users,$domain))" sAMAccountName | grep sAMAccountName | cut  -d":" -f2 | tee domain_admins.lst ;; 
    5 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "(objectClass=computer)" name dNSHostname operatingSystem operatingSystemVersion lastLogonTimestamp servicePrincipalName | tee domain_computers.lst ;;
    6 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "(&(&(servicePrincipalName=*)(UserAccountControl:1.2.840.113556.1.4.803:=512))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))" | tee kerberoast_spns.lst ;; 
    7 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "servicePrincipalName=*" sAMAccountName servicePrincipalName | tee service_principle_names.lst ;;
    8 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "objectClass=groupPolicyContainer" displayName gPCFileSysPath | tee gpo_names.lst ;; 
    9 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | tee users_unconstrained_delegation.lst ;;
    10 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "(&(objectCategory=computer)(objectClass=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | tee computers_unconstrained_delegation.lst ;; 
    11 )
	ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "adminCount=1" dn | tee admin_objects.lst ;;
    12 )
        ldapsearch -LLL -x -H ldap://$1 -D "$2@$1" -w $3 -b $domain "(|(userPassword=*)(krbprincipalkey=*)(sambalmpassword=*)(sambantpassword=*))" uid userPassword krbprincipalkey sambalmpassword sambantpassword ;;
esac
